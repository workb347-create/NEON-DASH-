<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEON DASH: ULTIMATE TRAIL</title>
    <style>
        :root { --p: #00ffcc; --bg: #030508; --panel: rgba(10, 15, 25, 0.98); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        canvas { display: block; touch-action: none; }
        .overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(10px); }
        .panel { background: var(--panel); border: 2px solid var(--p); padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 320px; }
        .btn { background: var(--p); color: #000; border: none; padding: 12px 0; border-radius: 10px; font-size: 16px; font-weight: 800; cursor: pointer; width: 100%; margin: 8px 0; text-transform: uppercase; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        .btn-sec { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.2); }
        #prog-bar { position: absolute; top: 25px; left: 50%; transform: translateX(-50%); width: 60%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; z-index: 10; }
        #prog-fill { height: 100%; width: 0%; background: var(--p); box-shadow: 0 0 15px var(--p); }
        #lvl-info { position: absolute; bottom: 80px; width: 100%; text-align: center; font-size: 22px; font-weight: 900; opacity: 0; transition: 0.5s; color: var(--p); text-shadow: 0 0 10px var(--p); pointer-events: none; }
        .hidden { display: none !important; }
        #pause-btn { position: absolute; top: 20px; right: 20px; width: 45px; height: 45px; background: var(--panel); border: 1px solid var(--p); color: var(--p); border-radius: 10px; z-index: 50; cursor: pointer; font-weight: bold; }
        .lvl-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; max-height: 250px; overflow-y: auto; padding: 5px; }
        .lvl-item { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #333; transition: 0.3s; font-weight: bold; }
        .unlocked { border-color: var(--p); color: var(--p); box-shadow: inset 0 0 8px rgba(0,255,204,0.2); }
    </style>
</head>
<body>

    <div id="prog-bar"><div id="prog-fill"></div></div>
    <div id="lvl-info">LEVEL NAME</div>
    <button id="pause-btn" class="hidden" onclick="Game.togglePause()">II</button>

    <div id="mainMenu" class="overlay">
        <div class="panel">
            <h1 id="ui-title">NEON DASH</h1>
            <p id="ui-best">BEST: LEVEL 1</p>
            <button class="btn" id="ui-play" onclick="Game.start(Game.maxLevel)">PLAY</button>
            <button class="btn btn-sec" id="ui-levels" onclick="UI.show('levelsMenu')">LEVELS</button>
            <button class="btn btn-sec" id="ui-settings" onclick="UI.show('settingsMenu')">SETTINGS</button>
        </div>
    </div>

    <div id="levelsMenu" class="overlay hidden">
        <div class="panel">
            <h2 id="ui-select">SELECT LEVEL</h2>
            <div id="lvl-grid" class="lvl-grid"></div>
            <button class="btn" id="ui-back" onclick="UI.show('mainMenu')">BACK</button>
        </div>
    </div>

    <div id="settingsMenu" class="overlay hidden">
        <div class="panel">
            <h2 id="ui-sets-title">SETTINGS</h2>
            <button class="btn btn-sec" onclick="UI.nextLang()" id="lang-btn">LANGUAGE: EN</button>
            <button class="btn" style="background:#ff3b3b; color:white;" id="ui-reset" onclick="Game.reset()">RESET PROGRESS</button>
            <button class="btn" id="ui-back2" onclick="UI.show('mainMenu')">BACK</button>
        </div>
    </div>

    <div id="pauseMenu" class="overlay hidden">
        <div class="panel">
            <h2 id="ui-paused">PAUSED</h2>
            <button class="btn" id="ui-resume" onclick="Game.togglePause()">RESUME</button>
            <button class="btn btn-sec" id="ui-restart" onclick="Game.start(Game.level)">RESTART</button>
            <button class="btn btn-sec" id="ui-quit" style="color:#ff3b3b;" onclick="Game.quit()">QUIT</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const Langs = {
    EN: { title: "NEON DASH", play: "PLAY", levels: "LEVELS", settings: "SETTINGS", select: "SELECT LEVEL", back: "BACK", reset: "RESET PROGRESS", paused: "PAUSED", resume: "RESUME", restart: "RESTART", quit: "QUIT", best: "BEST: LEVEL ", setsTitle: "SETTINGS" },
    AR: { title: "نيون داش", play: "لعب", levels: "المستويات", settings: "الإعدادات", select: "اختر المستوى", back: "رجوع", reset: "مسح التقدم", paused: "توقف مؤقت", resume: "استئناف", restart: "إعادة", quit: "خروج", best: "أفضل مستوى: ", setsTitle: "الإعدادات" },
    FR: { title: "NEON DASH", play: "JOUER", levels: "NIVEAUX", settings: "OPTIONS", select: "NIVEAUX", back: "RETOUR", reset: "RÉINITIALISER", paused: "PAUSE", resume: "REPRENDRE", restart: "REJOUER", quit: "QUITTER", best: "MEILLEUR: NIVEAU ", setsTitle: "OPTIONS" }
};

let curLang = localStorage.getItem('nd_lang') || 'EN';

const LevelData = Array.from({length: 30}, (_, i) => {
    let lvl = i + 1;
    let speed = 9.5 + (lvl * 0.42);
    let mode = lvl % 3 === 0 ? "ship" : (lvl % 3 === 1 ? "cube" : "gravity");
    let map = lvl < 3 ? "S.B.S.B.S" : "SSS.B.SSS.P.S.SSS.G.SSS.B.SSS.SSS.G.SSS.P.SSS";
    if (lvl > 20) speed = Math.min(speed + 1.5, 20); 
    return { name: lvl > 20 ? "DEMON " + lvl : (lvl > 10 ? "HARD " + lvl : "LEVEL " + lvl), mode, color: `hsl(${lvl * 18}, 100%, 50%)`, speed, map };
});

const Game = {
    canvas: document.getElementById('gameCanvas'),
    ctx: document.getElementById('gameCanvas').getContext('2d'),
    active: false, paused: false, level: 1, 
    maxLevel: parseInt(localStorage.getItem('nd_max')) || 1,
    scrollX: 0, gravity: 1.5,
    player: { x: 150, y: 0, w: 34, h: 34, vy: 0, rot: 0, gSign: 1, mode: "cube" },
    objects: [], particles: [],

    init() {
        this.resize(); window.onresize = () => this.resize();
        UI.updateTexts(); UI.buildLevels(); this.loop();
    },

    resize() { this.w = window.innerWidth; this.h = window.innerHeight; this.canvas.width = this.w; this.canvas.height = this.h; },

    start(lvlNum) {
        let lIdx = lvlNum - 1;
        const cfg = LevelData[lIdx];
        this.level = lvlNum;
        this.player.mode = cfg.mode;
        this.player.gSign = 1;
        this.speed = cfg.speed;
        this.curColor = cfg.color;
        document.documentElement.style.setProperty('--p', cfg.color);
        this.objects = []; this.particles = []; let x = 800;
        
        cfg.map.split('.').forEach(part => {
            let spacing = (lvlNum > 20) ? 480 : 440;
            if(part === 'SSS') { this.objects.push({t:'spike',x,y:-40},{t:'spike',x:x+36,y:-40},{t:'spike',x:x+72,y:-40}); x+=108; }
            else if(part === 'S') { this.objects.push({t:'spike',x,y:-40}); x+=40; }
            else if(part === 'B') { this.objects.push({t:'block',x,y:-130,w:90,h:40}); x+=90; }
            else if(part === 'P') { this.objects.push({t:'portal',x,y:-210,w:45,h:170}); x+=45; }
            else if(part === 'G') { this.objects.push({t:'gap',x,y:-260}); x+=50; }
            x += Math.max(180, spacing - (lvlNum * 8.1)); 
        });
        
        this.levelEnd = x + 1000; this.scrollX = 0; this.player.y = this.h/2; this.player.vy = 0;
        this.player.dead = false; this.active = true; this.paused = false;
        document.getElementById('lvl-info').innerText = cfg.name;
        document.getElementById('lvl-info').style.opacity = 1;
        setTimeout(()=>document.getElementById('lvl-info').style.opacity=0, 2000);
        document.getElementById('pause-btn').classList.remove('hidden');
        UI.show('dummy');
    },

    die() { if(!this.player.dead) { this.player.dead = true; this.particles = []; setTimeout(() => this.start(this.level), 400); } },

    update() {
        if(!this.active || this.paused || this.player.dead) return;
        this.scrollX += this.speed;
        if(this.player.mode === "ship") {
            this.player.vy += (UI.pressing ? -0.7 : 0.7);
            this.player.vy *= 0.98;
            this.player.rot = this.player.vy * 0.08;
        } else { this.player.vy += this.gravity * this.player.gSign; }
        
        this.player.y += this.player.vy;
        const gy = this.h - 80, ty = 80;

        // Trail Logic
        if(Math.random() > 0.3) {
            this.particles.push({
                x: this.player.x, y: this.player.y + 10 + Math.random()*14, 
                sz: 8 + Math.random()*10, life: 1.0, 
                vx: -this.speed * 0.2, vy: (Math.random()-0.5)*2
            });
        }

        if(this.player.y + this.player.h > gy || this.player.y < ty) {
            if(this.player.mode === "ship") return this.die();
            if(this.player.y + this.player.h > gy) { this.player.y = gy-this.player.h; this.player.vy = 0; this.player.onGround = (this.player.gSign>0); }
            else { this.player.y = ty; this.player.vy = 0; this.player.onGround = (this.player.gSign<0); }
            this.player.rot = Math.round(this.player.rot/1.57)*1.57;
        } else { 
            this.player.onGround = false; 
            if(this.player.mode !== "ship") this.player.rot += 0.25 * this.player.gSign; 
        }

        this.particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life -= 0.05; p.sz *= 0.94; if(p.life <= 0) this.particles.splice(i, 1); });

        this.objects.forEach(o => {
            let ox = o.x - this.scrollX + this.player.x, oy = (this.player.gSign > 0) ? gy + o.y : ty - o.y - (o.h||40);
            if(o.t === 'portal' && Math.abs(this.player.x - ox) < 20) { this.player.gSign *= -1; o.x = -9999; }
            let p = 5; 
            if (this.player.x+p < ox+(o.w||40)-p && this.player.x+this.player.w-p > ox+p &&
                this.player.y+p < oy+(o.h||40)-p && this.player.y+this.player.h-p > oy+p) {
                if(o.t === 'spike' || o.t === 'gap') this.die();
                else if(o.t === 'block') {
                    let landing = (this.player.gSign > 0 && this.player.vy >= 0 && this.player.y + this.player.h < oy + 22) || 
                                  (this.player.gSign < 0 && this.player.vy <= 0 && this.player.y > oy + (o.h||40) - 22);
                    if(landing) { this.player.vy = 0; this.player.onGround = true; this.player.y = (this.player.gSign>0) ? oy-this.player.h : oy+(o.h||40); }
                    else this.die();
                }
            }
        });

        document.getElementById('prog-fill').style.width = Math.min(100, (this.scrollX/this.levelEnd*100))+'%';
        if(this.scrollX > this.levelEnd) {
            if(this.level === this.maxLevel && this.maxLevel < 30) { this.maxLevel++; localStorage.setItem('nd_max', this.maxLevel); UI.buildLevels(); }
            this.quit();
        }
    },

    draw() {
        const ctx = this.ctx; ctx.clearRect(0,0,this.w,this.h);
        const gy = this.h - 80, ty = 80;
        ctx.fillStyle = "#0a0c14"; ctx.fillRect(0, gy, this.w, 80); ctx.fillRect(0, 0, this.w, ty);
        
        // Draw Particles
        this.particles.forEach(p => {
            ctx.fillStyle = this.curColor; ctx.globalAlpha = p.life * 0.5;
            ctx.fillRect(p.x, p.y, p.sz, p.sz);
        });
        ctx.globalAlpha = 1.0;

        if(!this.player.dead && this.active) {
            ctx.save(); ctx.translate(this.player.x + 17, this.player.y + 17); ctx.rotate(this.player.rot);
            ctx.fillStyle = "var(--p)"; ctx.fillRect(-17, -17, 34, 34);
            ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.strokeRect(-13, -13, 26, 26); ctx.restore();
        }
        this.objects.forEach(o => {
            let ox = o.x - this.scrollX + this.player.x, oy = (this.player.gSign > 0) ? gy + o.y : ty - o.y - (o.h||40);
            if(o.t==='spike') { ctx.fillStyle="#ff3b3b"; ctx.beginPath(); if(this.player.gSign>0){ctx.moveTo(ox,oy+40);ctx.lineTo(ox+20,oy);ctx.lineTo(ox+40,oy+40);}else{ctx.moveTo(ox,oy);ctx.lineTo(ox+20,oy+40);ctx.lineTo(ox+40,oy);} ctx.fill(); }
            else if(o.t==='gap') { ctx.fillStyle="#ff3b3b"; ctx.fillRect(ox,0,40,this.h/2-105); ctx.fillRect(ox,this.h/2+105,40,this.h); }
            else if(o.t==='portal') { ctx.strokeStyle="#ff00ff"; ctx.lineWidth=3; ctx.strokeRect(ox,oy,45,170); }
            else { ctx.fillStyle="#151515"; ctx.fillRect(ox,oy,o.w,o.h); ctx.strokeStyle="white"; ctx.strokeRect(ox,oy,o.w,o.h); }
        });
    },
    loop() { this.update(); this.draw(); requestAnimationFrame(()=>this.loop()); },
    togglePause() { if(!this.active) return; this.paused = !this.paused; UI.show(this.paused?'pauseMenu':'dummy'); },
    quit() { this.active = false; document.getElementById('pause-btn').classList.add('hidden'); UI.show('mainMenu'); UI.updateTexts(); },
    reset() { if(confirm(Langs[curLang].reset + "?")) { localStorage.clear(); location.reload(); } }
};

const UI = {
    pressing: false,
    show(id) { document.querySelectorAll('.overlay').forEach(e=>e.classList.add('hidden')); if(id!=='dummy') document.getElementById(id).classList.remove('hidden'); },
    nextLang() { curLang = (curLang==='EN'?'AR':(curLang==='AR'?'FR':'EN')); localStorage.setItem('nd_lang', curLang); this.updateTexts(); },
    updateTexts() {
        const l = Langs[curLang];
        document.getElementById('ui-title').innerText = l.title;
        document.getElementById('ui-play').innerText = l.play;
        document.getElementById('ui-levels').innerText = l.levels;
        document.getElementById('ui-settings').innerText = l.settings;
        document.getElementById('ui-select').innerText = l.select;
        document.getElementById('ui-back').innerText = l.back;
        document.getElementById('ui-back2').innerText = l.back;
        document.getElementById('ui-sets-title').innerText = l.setsTitle;
        document.getElementById('ui-reset').innerText = l.reset;
        document.getElementById('ui-paused').innerText = l.paused;
        document.getElementById('ui-resume').innerText = l.resume;
        document.getElementById('ui-restart').innerText = l.restart;
        document.getElementById('ui-quit').innerText = l.quit;
        document.getElementById('ui-best').innerText = l.best + Game.maxLevel;
        document.getElementById('lang-btn').innerText = (curLang==='AR'?'اللغة: ':'LANGUAGE: ') + curLang;
    },
    buildLevels() {
        const grid = document.getElementById('lvl-grid'); grid.innerHTML = '';
        for(let i=1; i<=30; i++) {
            const div = document.createElement('div');
            div.className = `lvl-item ${i <= Game.maxLevel ? 'unlocked' : ''}`;
            div.innerText = i;
            if(i <= Game.maxLevel) div.onclick = () => Game.start(i);
            grid.appendChild(div);
        }
    }
};

const jump = (e) => { if(e) e.preventDefault(); UI.pressing = true; if(Game.active && !Game.paused && !Game.player.dead && Game.player.mode!=="ship" && Game.player.onGround) Game.player.vy = -17 * Game.player.gSign; };
window.onmousedown = jump; window.onmouseup = () => UI.pressing = false;
window.ontouchstart = jump; window.ontouchend = () => UI.pressing = false;
window.onkeydown = (e) => { if(e.code==='Space') jump(); if(e.code==='Escape') Game.togglePause(); };
window.onkeyup = (e) => { if(e.code==='Space') UI.pressing = false; };
Game.init();
</script>
</body>
</html>
